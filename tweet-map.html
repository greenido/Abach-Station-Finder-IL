<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Alerts IL - Tweet to Map</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Alerts in Israel">
    <meta name="author" content="Ido Green | greenido.wordpress.com | @greenido">

    <!-- css -->
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />
    <link rel="stylesheet" href="css/style.css" />
    
    <!-- js -->
    <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>

    <style type="text/css">
      /*html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }*/
      #map_canvas { 
        height: 600px;
      }
      #bodyContent {
        background-color: rgba(223, 223, 197, 0.72);
        border-radius: 15px;
        padding: 1em;
      }
      #tweetContent {
        width: 250px;
      }
      .userTweet {
        background-color: #F1F162;
        font-size: 110%;
        padding: 6px;
        font-weight: bold;
      }
    </style>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD_mrsCOGa_cip-_O9YzmruYQ831uQcqPE&sensor=true">
    </script>
    <script>
      var map;
      var markersArray = [];
      var lastInfoWin;

      function initialize() {
        var mapOptions = {
          center: new google.maps.LatLng(32.07, 34.8),
          zoom: 10,
          streetViewControl: true,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById("map_canvas"),
            mapOptions);

        fetchAndDraw("israel");
      }

      function addMarker(tmpLong, tmpLat, tweet) {
        console.log ("-- going to put marker on: " +tmpLong + ", " +tmpLat);
        var myLatlng = new google.maps.LatLng(tmpLong, tmpLat);
        var alertIcon = "img/alert-60-50.png";
        tweet['marker'] = new google.maps.Marker({
            position: myLatlng,
            mpa: map,
            icon: alertIcon,
            title:"Rocket zone"
        });
        markersArray.push(tweet['marker']);

        // todo - add option to click on links
        tweet['contentString'] = '<div id="tweetContent">'+
          '<img src="' + tweet.profile_image_url + '" style="float:left; width: 56px; height:56px; padding-right:0.5em"/>' + 
          '<span class="userTweet"><a href="https://twitter.com/'+ tweet.from_user + '" target="_blank">' + 
          tweet.from_user +'</a></span>'+
          '<div id="bodyContent">'+
          tweet.text +
          '<br/><small>Created at: ' + tweet.created_at + '</small>'+
          '</div></div>';

        tweet['infowindow'] = new google.maps.InfoWindow({
          content: tweet.contentString
        });

        google.maps.event.addListener(tweet.marker, 'click', function() {
          if (lastInfoWin) {
            lastInfoWin.close();
          }
          tweet.infowindow.open(map, tweet.marker);
          lastInfoWin = tweet.infowindow;
        });

        // To add the marker to the map, call setMap();        
        tweet.marker.setMap(map);

      }
      
      function clearOverlays() {
        if (markersArray) {
          for (i in markersArray) {
            markersArray[i].setMap(null);
          }
        }
      }


      $(document).on('pageinit','[data-role=page]', function(){
        console.log("--start the map party--");
        $.mobile.touchOverflowEnabled = true;
        
        $("#reload").click(function() {
          clearOverlays();
          // to 'url' the strings
          fetchAndDraw($("#tweetSearch").val());
        });

      });

      // tune the fetching of relevate tweets
      function fetchAndDraw(searchTerm) {
          var searchTerm = encodeURI(searchTerm);
          $.mobile.showPageLoadingMsg();
          $.ajax({
            url: 'http://search.twitter.com/search.json?geocode=32.781157,34.398720,50mi&rpp=100&q='+searchTerm,
            type: 'GET',
            dataType: 'jsonp',
            success: function(data, textStatus, xhr) {
              var i;
              $.mobile.hidePageLoadingMsg();
              var bounds = new google.maps.LatLngBounds();
              for (i = 0; i < data.results.length; i++) {
                var tweet = data.results[i];
                if (tweet.geo != null) {
                  addMarker(tweet.geo.coordinates[0], tweet.geo.coordinates[1], tweet);
                  var pos = new google.maps.LatLng(tweet.geo.coordinates[0], tweet.geo.coordinates[1]);
                  bounds.extend(pos);
                }
                else {
                  // TODO: translate from location to long/lat
                  //console.log("no geo but location: " + tweet.location);
                }
              }
              // make sure our map is AROUND all the tweets
              map.fitBounds(bounds);
            },
            error: function(jqXHR, textStatus, errorThrown){
              console.error("Opss... Error: " + errorThrown);
              $.mobile.hidePageLoadingMsg();
            }
          });

          // check again every minute
          setTimeout(fetchAndDraw, 60000);
        }
      
    </script>
  </head>
  <body onload="initialize()">
    <div id="map_canvas" style="width:100%; height:400px;"></div>

    <div data-role="fieldcontain">
      <label for="tweetSearch">Search:</label>
      <input type="text" name="tweetSearch" id="tweetSearch" value="" />
    </div>  

    <button id="reload">Go</button>
  </body>
</html>