<!DOCTYPE html>
<html>
<head>
  <title>Alerts IL</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Alerts in Israel">
  <meta name="author" content="Ido Green | greenido.wordpress.com | @greenido">

  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />
  <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
  <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
  <script>

// forked from r http://jsdo.it/rotsuya/411c

// configuration
var maxLength = 20;

// TODO - change it to something better with append
document.write(
  '<div data-role="page" data-theme="e" id="list">' +
  '<div data-role="header" data-position="fixed">' +
  '<h1><span id="widgetTitle">Alerts IL</span> ' +
  '<span style="font-size: x-small">(2012)</span></h1>' +
  '</div>' +
  '<div data-role="content">' +
  '<ul data-role="listview" id="articleList">'
);

// add the list of alerts
for(var i=1; i<=maxLength; i++){
  document.write('<li id="list' + i + 
    '"><a href="#article'       + i + 
    '" id="link'                + i + 
    '">&nbsp;</a></li>'
  );
}

document.write('</ul>' + '  </div>' +'</div>');

for(i=1; i<=maxLength; i++){
  document.write(
    '<div data-role="page" data-theme="e" id="article' + i + '">' +
    ' <div data-role="header" data-theme="d" data-position="inline">' +
    '   <a href="#list" data-role="button" data-icon="grid" data-back="true">Main</a>' +
    '   <h1 id="articleHeader' + i + '">&nbsp;</h1>' +
    '   <a href="#" id="openButton' + i + '" data-role="button" data-icon="plus"' +
    '      class="ui-btn-right" rel="external">Open</a>' +
    '   </div>' + '  <div data-role="content">' +
    '    <div id="articleContent' + i + '" class="articleContent" style="direction: rtl;"></div>' +
    '      <div data-role="controlgroup" data-type="horizontal" style="direction: rtl;">' +
    '      <a href="#article' + String(i-1) + '" data-role="button" data-icon="arrow-l"' +
    '        data-inline="true" class="prevButton">Back</a>' +
    '      <a href="#article' + String(i+1) + '" data-role="button" data-icon="arrow-r"' +
    '        data-inline="true" class="nextButton" data-iconpos="right">Next</a>' +
    '   </div> </div> </div>'
  );
}

// use y! pipes for caching and easy mange to the feeds:
// parse them and fetch some more data base on the basic entries.
//
$(function(){

  // to skip pipes cache during dev mode - TODO remove it in prod!
  var tmpRand = 1; //Math.floor((Math.random()*10000000)+1);
  getOnlineFeed('http://pipes.yahoo.com/pipes/pipe.run?_id=866c24404f4ae093008efc6cff7d0d09' +
      '&_randomstuff='+ tmpRand +'&_render=rss')
  });

/* helpers */
var listEntries = function(json) {
  if (!json.responseData.feed.entries) {
    console.error("could not fetch the items from our feed");
    return false;
  } 
    
  var articleLength = json.responseData.feed.entries.length;
  articleLength     = (articleLength > maxLength) ? maxLength : articleLength;
  
  for (var i = 1; i <= articleLength ; i++) {
    var entry = json.responseData.feed.entries[i-1];

    var tmpLink = entry.link;
    // if (tmpLink.indexOf("..") > -1) {
    //   tmpLink = tmpLink.replace("../", "");
    //   tmpLink = "http://darom.gov.il/NewsAndArticles/LocalNews/" + tmpLink;
    // }

    $('#link' + i).text(entry.title);
    $('#articleHeader' + i).text(entry.title);
    $('#openButton' + i).attr('href', tmpLink);
    $('#openButton' + i).attr('target', "_blank");


    var desc = entry.content.replace(/(<([^>]+)>)/ig,"");
    $('#articleContent' + i).append(desc);
  }

  $('#article1 .prevButton').remove();
  $('#article' + articleLength + ' .nextButton').remove();
  if (articleLength < maxLength) {
    for (i = articleLength + 1; i <= maxLength; i++) {
      $('#list' + i).remove();
      $('#article' + i).remove();
    }
  }
};

var getOnlineFeed = function(url) {
  var script = document.createElement('script');
  script.setAttribute('src', 'http://ajax.googleapis.com/ajax/services/feed/load?callback=listEntries&hl=ja&output=json-in-script&q='
                      + encodeURIComponent(url)
                      + '&v=1.0&num=' + maxLength);
  script.setAttribute('type', 'text/javascript');
  document.documentElement.firstChild.appendChild(script);
};

var getOfflineFeed = function(url) {
  var script = document.createElement('script');
  script.setAttribute('src', url);
  script.setAttribute('type', 'text/javascript');
  document.documentElement.firstChild.appendChild(script);
};

</script>
</head>

<body>
.
</body>
</html>